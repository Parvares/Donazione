function generateExcel(formData, books) {
    const documentText = `DONAZIONE ALLA BIBLIOTECA ELSA MORANTE
Io sottoscritto ${formData.nome} ${formData.cognome}
Tessera n. ${formData.tessera || '_______________'}
Tel. ${formData.telefono || '_______________'}
e-mail ${formData.email}
dono alla Biblioteca le risorse documentarie allegate e autorizzo la biblioteca a destinarli all'uso che riterrà più opportuno (acquisizione al patrimonio, scambio, dono, bookcrossing o scarto, nel caso in cui, a giudizio insindacabile della biblioteca, i materiali risultino inutilizzabili) senza alcun vincolo per la biblioteca stessa nei miei confronti
Data: ${new Date().toLocaleDateString('it-IT')}`;

    const wb = XLSX.utils.book_new();

    const ws_data = [
        ['DONAZIONE ALLA BIBLIOTECA ELSA MORANTE'],
        [documentText.split('\n')[0]],
        [''],
        ...documentText.split('\n').slice(1).map(line => [line]),
        [''],
        ['Elenco dei libri donati:'],
        [''],
        ['Titolo', 'Autore', 'Editore', 'Anno', 'ISBN']
    ];

    books.forEach(book => {
        ws_data.push([book.title, book.author, book.publisher, book.year, book.isbn]);
    });

    const ws = XLSX.utils.aoa_to_sheet(ws_data);

    // Set column widths
    ws['!cols'] = [
        { wch: 40 }, // Title
        { wch: 30 }, // Author
        { wch: 30 }, // Publisher
        { wch: 10 }, // Year
        { wch: 15 }  // ISBN
    ];

    // Apply styles to all cells
    const range = XLSX.utils.decode_range(ws['!ref']);
    for (let R = range.s.r; R <= range.e.r; ++R) {
        for (let C = range.s.c; C <= range.e.c; ++C) {
            const cell_address = XLSX.utils.encode_cell({ r: R, c: C });
            if (!ws[cell_address]) continue;

            // General cell styles
            ws[cell_address].s = {
                font: { name: "Arial", sz: 11 },
                alignment: { horizontal: "center", vertical: "center" },
                border: {
                    top: { style: "thin", color: { rgb: "000000" } },
                    bottom: { style: "thin", color: { rgb: "000000" } },
                    left: { style: "thin", color: { rgb: "000000" } },
                    right: { style: "thin", color: { rgb: "000000" } }
                }
            };

            // Highlight headers
            if (R === 7) {
                ws[cell_address].s.font.bold = true;
                ws[cell_address].s.fill = { fgColor: { rgb: "D9E1F2" } };
            }

            // Alternate row colors
            if (R > 7 && R % 2 === 0) {
                ws[cell_address].s.fill = { fgColor: { rgb: "F2F2F2" } };
            }
        }
    }

    XLSX.utils.book_append_sheet(wb, ws, "Donazione");

    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });

    function s2ab(s) {
        const buf = new ArrayBuffer(s.length);
        const view = new Uint8Array(buf);
        for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
        return buf;
    }

    const blob = new Blob([s2ab(wbout)], { type: 'application/octet-stream' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `donazione_${formData.cognome}_${formData.nome}.xlsx`;
    a.click();
    window.URL.revokeObjectURL(url);
}
