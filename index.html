import { useState } from 'react';
import { AlertCircle, Check, X, Loader2 } from 'lucide-react';
import { Alert, AlertTitle, AlertDescription } from '@/components/ui/alert';

const BookEntry = ({ book, index, onChange, onRemove, onAdd, isLast }) => (
  <div className="relative bg-gray-50 border border-gray-200 rounded-lg p-5 mb-5 hover:-translate-y-1 transition-transform">
    <div className="flex justify-between items-center mb-4">
      <span className="flex items-center justify-center w-6 h-6 rounded-full bg-green-500 text-white font-semibold text-sm">
        {index + 1}
      </span>
      {index > 0 && (
        <button 
          type="button"
          onClick={onRemove}
          className="px-3 py-2 text-red-600 hover:text-red-700 font-bold text-2xl"
        >
          <X />
        </button>
      )}
    </div>

    <div className="space-y-4">
      <div>
        <label className="block mb-1 text-slate-700 font-medium">Titolo: *</label>
        <input
          type="text"
          value={book.title}
          onChange={(e) => onChange(index, 'title', e.target.value)}
          required
          className="w-full px-3 py-2 border-2 border-gray-300 rounded focus:border-blue-500 focus:outline-none"
        />
      </div>

      <div>
        <label className="block mb-1 text-slate-700 font-medium">Autore:</label>
        <input
          type="text"
          value={book.author}
          onChange={(e) => onChange(index, 'author', e.target.value)}
          className="w-full px-3 py-2 border-2 border-gray-300 rounded focus:border-blue-500 focus:outline-none"
        />
      </div>

      <div>
        <label className="block mb-1 text-slate-700 font-medium">Editore:</label>
        <input
          type="text"
          value={book.publisher}
          onChange={(e) => onChange(index, 'publisher', e.target.value)}
          className="w-full px-3 py-2 border-2 border-gray-300 rounded focus:border-blue-500 focus:outline-none"
        />
      </div>

      <div>
        <label className="block mb-1 text-slate-700 font-medium">Anno:</label>
        <input
          type="number"
          value={book.year}
          onChange={(e) => onChange(index, 'year', e.target.value)}
          min="1900"
          max={new Date().getFullYear()}
          className="w-full px-3 py-2 border-2 border-gray-300 rounded focus:border-blue-500 focus:outline-none"
        />
      </div>

      <div>
        <label className="block mb-1 text-slate-700 font-medium">ISBN:</label>
        <input
          type="text"
          value={book.isbn}
          onChange={(e) => onChange(index, 'isbn', e.target.value)}
          pattern="\d{10}|\d{13}"
          className="w-full px-3 py-2 border-2 border-gray-300 rounded focus:border-blue-500 focus:outline-none"
        />
      </div>

      {isLast && (
        <button
          type="button"
          onClick={onAdd}
          className="w-full px-4 py-3 bg-green-500 text-white rounded hover:bg-green-600 transition-colors mt-2"
        >
          + Aggiungi Libro
        </button>
      )}
    </div>
  </div>
);

const DonationForm = () => {
  const [formData, setFormData] = useState({
    nome: '',
    cognome: '',
    tessera: '',
    telefono: '',
    email: '',
    acceptTerms: false
  });

  const [books, setBooks] = useState([{
    title: '',
    author: '',
    publisher: '',
    year: '',
    isbn: ''
  }]);

  const [status, setStatus] = useState({
    loading: false,
    error: null,
    success: false
  });

  const validateForm = () => {
    if (!formData.nome || !formData.cognome || !formData.email) {
      setStatus({ error: 'Compilare tutti i campi obbligatori' });
      return false;
    }

    if (!formData.acceptTerms) {
      setStatus({ error: 'Accettare i termini e condizioni' });
      return false;
    }

    if (!books.some(book => book.title)) {
      setStatus({ error: 'Aggiungere almeno un libro' });
      return false;
    }

    return true;
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    if (!validateForm()) return;

    setStatus({ loading: true });

    try {
      // EmailJS configuration would go here
      setStatus({ success: true });
      // Reset form
      setFormData({
        nome: '',
        cognome: '',
        tessera: '',
        telefono: '',
        email: '',
        acceptTerms: false
      });
      setBooks([{ title: '', author: '', publisher: '', year: '', isbn: '' }]);
    } catch (error) {
      setStatus({ error: error.message });
    }
  };

  return (
    <div className="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-md">
      <div className="flex flex-col items-center justify-center mb-10 text-center space-y-4">
        <img src="/api/placeholder/200/80" alt="Logo Biblioteca" className="h-16 w-auto object-contain" />
        <h1 className="text-3xl text-slate-700 font-bold">Donazione di libri</h1>
      </div>

      <Alert className="mb-6">
        <AlertCircle className="h-4 w-4" />
        <AlertTitle>Importante</AlertTitle>
        <AlertDescription>
          Compila il modulo per donare i tuoi libri alla biblioteca. I campi contrassegnati con * sono obbligatori
        </AlertDescription>
      </Alert>

      <form onSubmit={handleSubmit} noValidate>
        {/* Personal Information Section */}
        <h3 className="text-xl text-slate-700 mt-6 mb-4 pb-2 border-b-2 border-gray-200">
          Dati Personali
        </h3>
        
        {/* Form fields */}
        <div className="space-y-4">
          {/* Books Section */}
          <h3 className="text-xl text-slate-700 mt-6 mb-4 pb-2 border-b-2 border-gray-200">
            Libri da donare
          </h3>
          
          {books.map((book, index) => (
            <BookEntry
              key={index}
              book={book}
              index={index}
              onChange={(index, field, value) => {
                const newBooks = [...books];
                newBooks[index][field] = value;
                setBooks(newBooks);
              }}
              onRemove={() => {
                setBooks(books.filter((_, i) => i !== index));
              }}
              onAdd={() => {
                setBooks([...books, { title: '', author: '', publisher: '', year: '', isbn: '' }]);
              }}
              isLast={index === books.length - 1}
            />
          ))}

          {/* Status Messages */}
          {status.error && (
            <Alert variant="destructive">
              <AlertCircle className="h-4 w-4" />
              <AlertDescription>{status.error}</AlertDescription>
            </Alert>
          )}
          
          {status.success && (
            <Alert className="bg-green-50 text-green-800 border-green-500">
              <Check className="h-4 w-4" />
              <AlertDescription>Donazione inviata con successo!</AlertDescription>
            </Alert>
          )}

          <button
            type="submit"
            disabled={status.loading}
            className="w-full max-w-sm mx-auto block px-6 py-3 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors font-medium disabled:opacity-50"
          >
            {status.loading ? (
              <span className="flex items-center justify-center">
                <Loader2 className="animate-spin mr-2" />
                Invio in corso...
              </span>
            ) : (
              'Invia Donazione'
            )}
          </button>
        </div>
      </form>
    </div>
  );
};

export default DonationForm;
