<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donazione alla Biblioteca Elsa Morante</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 leading-relaxed p-5">
    <div class="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-md">
        <!-- Form and content here -->

        <form id="donationForm">
            <h3 class="text-xl text-slate-700 mt-6 mb-4 pb-2 border-b-2 border-gray-200">Dati Personali</h3>
            
            <div class="mb-5">
                <label for="nome" class="block mb-1 text-slate-700 font-medium">Nome: *</label>
                <input type="text" id="nome" name="nome" required class="w-full px-3 py-2 border-2 border-gray-300 rounded focus:border-blue-500 focus:outline-none text-base">
                <div id="nomeWarning" class="text-red-500 text-sm mt-1 hidden">Il campo nome è obbligatorio.</div>
            </div>
            
            <div class="mb-5">
                <label for="cognome" class="block mb-1 text-slate-700 font-medium">Cognome: *</label>
                <input type="text" id="cognome" name="cognome" required class="w-full px-3 py-2 border-2 border-gray-300 rounded focus:border-blue-500 focus:outline-none text-base">
                <div id="cognomeWarning" class="text-red-500 text-sm mt-1 hidden">Il campo cognome è obbligatorio.</div>
            </div>
            
            <div class="mb-5">
                <label for="email" class="block mb-1 text-slate-700 font-medium">Email: *</label>
                <input type="email" id="email" name="email" required class="w-full px-3 py-2 border-2 border-gray-300 rounded focus:border-blue-500 focus:outline-none text-base">
                <div id="emailWarning" class="text-red-500 text-sm mt-1 hidden">Inserisci un indirizzo email valido.</div>
            </div>

            <div class="bg-gray-50 p-4 rounded mb-5">
                <label class="flex items-start gap-3">
                    <input type="checkbox" id="accept" name="accept" required class="w-5 h-5 mt-1">
                    <span>Ho letto e accetto <a href="termini.html" target="_blank" class="text-blue-500 hover:underline">termini e condizioni</a></span>
                </label>
            </div>

            <button type="submit" class="w-full max-w-sm mx-auto block px-6 py-3 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors font-medium text-base">
                Accetta e Genera il Documento
            </button>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Handle input validation for fields
            const nomeInput = document.getElementById('nome');
            const cognomeInput = document.getElementById('cognome');
            const emailInput = document.getElementById('email');
            const telefonoInput = document.getElementById('telefono');
            const bookList = document.getElementById('bookList');

            // Inline warning function
            function showInlineWarning(inputElement, message) {
                const warningDiv = document.getElementById(`${inputElement.id}Warning`);
                warningDiv.textContent = message;
                warningDiv.classList.remove('hidden');
            }

            // Remove warning message when user starts typing
            function removeInlineWarning(inputElement) {
                const warningDiv = document.getElementById(`${inputElement.id}Warning`);
                warningDiv.classList.add('hidden');
            }

            // Set event listeners for inline warnings
            nomeInput.addEventListener('input', () => removeInlineWarning(nomeInput));
            cognomeInput.addEventListener('input', () => removeInlineWarning(cognomeInput));
            emailInput.addEventListener('input', () => removeInlineWarning(emailInput));

            telefonoInput.addEventListener('input', function(e) {
                const originalValue = e.target.value;
                e.target.value = originalValue.replace(/[^0-9]/g, '');

                if (originalValue !== e.target.value) {
                    showInlineWarning(this, 'Inserire solo numeri nel campo Telefono');
                }
            });

            emailInput.addEventListener('input', function(e) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                const originalValue = e.target.value;

                if (originalValue && !emailRegex.test(originalValue)) {
                    showInlineWarning(this, 'Inserire un indirizzo email valido');
                }
            });

            // Handle form submission
            document.getElementById('donationForm').addEventListener('submit', async function(event) {
                event.preventDefault();
                
                const nome = document.getElementById('nome').value.trim();
                const cognome = document.getElementById('cognome').value.trim();
                const email = document.getElementById('email').value.trim();
                const acceptCheckbox = document.getElementById('accept');

                // Validate required fields
                let isValid = true;
                if (!nome) {
                    showInlineWarning(nomeInput, 'Il campo nome è obbligatorio.');
                    isValid = false;
                }

                if (!cognome) {
                    showInlineWarning(cognomeInput, 'Il campo cognome è obbligatorio.');
                    isValid = false;
                }

                if (!email) {
                    showInlineWarning(emailInput, 'Inserisci un indirizzo email valido.');
                    isValid = false;
                }

                if (!acceptCheckbox.checked) {
                    alert('Devi accettare i termini e le condizioni per procedere.');
                    isValid = false;
                }

                if (!isValid) {
                    return;
                }

                // Process the rest of the form and generate the document
                const books = [];
                const bookEntries = document.querySelectorAll('.book-entry');
                
                for (const bookDiv of bookEntries) {
                    const title = bookDiv.querySelector('.book-title').value.trim();
                    if (!title) {
                        alert('Per favore inserisci almeno il titolo per ogni libro.');
                        return;
                    }
                    books.push({
                        title: title,
                        author: bookDiv.querySelector('.book-author').value.trim(),
                        publisher: bookDiv.querySelector('.book-publisher').value.trim(),
                        year: bookDiv.querySelector('.book-year').value.trim(),
                        isbn: bookDiv.querySelector('.book-isbn').value.trim()
                    });
                }

                if (books.length === 0) {
                    alert('Aggiungi almeno un libro alla donazione.');
                    return;
                }

                // Proceed to generate the Excel document
                const formData = { nome, cognome, email, telefono: telefonoInput.value.trim() };

                await generateExcel(formData, books);

                // Show success popup
                showEmailPopup();
            });

            function showEmailPopup() {
                const popup = document.createElement('div');
                popup.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center z-50';
                popup.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-lg w-96 text-center">
                        <h2 class="text-xl font-semibold mb-4">Documento generato con successo!</h2>
                        <p class="mb-4">Il documento è stato scaricato correttamente. Invialo a: l.daniello@bibliotechediroma.it</p>
                        <button id="sendEmailBtn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Invia a email</button>
                        <button id="closePopupBtn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 mt-3">Chiudi</button>
                    </div>
                `;
                document.body.appendChild(popup);
                
                document.getElementById('sendEmailBtn').addEventListener('click', function() {
                    // Implement email sending functionality if necessary
                    alert("Email inviata!");
                    popup.remove();
                });

                document.getElementById('closePopupBtn').addEventListener('click', function() {
                    popup.remove();
                });
            }
        });

        async function generateExcel(formData, books) {
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Donazione');
            
            worksheet.columns = [
                { header: 'Nome', key: 'nome', width: 30 },
                { header: 'Cognome', key: 'cognome', width: 30 },
                { header: 'Email', key: 'email', width: 30 },
                { header: 'Telefono', key: 'telefono', width: 15 },
                { header: 'Titolo', key: 'titolo', width: 50 },
                { header: 'Autore', key: 'autore', width: 50 },
                { header: 'Editore', key: 'editore', width: 50 },
                { header: 'Anno', key: 'anno', width: 10 },
                { header: 'ISBN', key: 'isbn', width: 20 }
            ];

            worksheet.addRow(formData);
            books.forEach(book => worksheet.addRow(book));

            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'donazione_biblioteca_elsa_morante.xlsx';
            link.click();
        }
    </script>
</body>
</html>
