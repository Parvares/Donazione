function generateExcel(formData, books) {
    const documentText = `DONAZIONE ALLA BIBLIOTECA ELSA MORANTE

Io sottoscritto ${formData.nome} ${formData.cognome}
Tessera n. ${formData.tessera || '_______________'} 
Tel. ${formData.telefono || '_______________'} 
e-mail ${formData.email}

dono alla Biblioteca le risorse documentarie allegate e autorizzo la biblioteca a destinarli all'uso che riterrà più opportuno (acquisizione al patrimonio, scambio, dono, bookcrossing o scarto, nel caso in cui, a giudizio insindacabile della biblioteca, i materiali risultino inutilizzabili) senza alcun vincolo per la biblioteca stessa nei miei confronti

Data: ${new Date().toLocaleDateString('it-IT')}
`;

    const wb = XLSX.utils.book_new();
    
    // Donation Details Sheet
    const detailsData = [
        ['Donazione alla Biblioteca Elsa Morante'],
        [],
        ['DATI DONATORE'],
        ['Nome', formData.nome],
        ['Cognome', formData.cognome],
        ['Numero Tessera', formData.tessera || 'Non specificato'],
        ['Telefono', formData.telefono || 'Non specificato'],
        ['Email', formData.email],
        [],
        ['Data Donazione', new Date().toLocaleDateString('it-IT')]
    ];

    const detailsWs = XLSX.utils.aoa_to_sheet(detailsData);

    // Styling for details sheet
    detailsWs['A1'].s = { 
        font: { bold: true, sz: 14 },
        alignment: { horizontal: 'center' }
    };
    detailsWs['!cols'] = [{ wch: 20 }, { wch: 30 }];

    // Books Sheet
    const booksData = [
        ['Elenco Libri Donati'],
        [],
        ['Titolo', 'Autore', 'Editore', 'Anno', 'ISBN']
    ];

    books.forEach(book => {
        booksData.push([
            book.title || 'Non specificato', 
            book.author || 'Non specificato', 
            book.publisher || 'Non specificato', 
            book.year || 'Non specificato', 
            book.isbn || 'Non specificato'
        ]);
    });

    const booksWs = XLSX.utils.aoa_to_sheet(booksData);

    // Styling for books sheet
    booksWs['A1'].s = { 
        font: { bold: true, sz: 14 },
        alignment: { horizontal: 'center' }
    };
    booksWs['A3'].s = { 
        font: { bold: true },
        fill: { fgColor: { rgb: 'E0E0E0' } }
    };
    booksWs['!cols'] = [
        { wch: 40 },  // Title
        { wch: 30 },  // Author
        { wch: 30 },  // Publisher
        { wch: 10 },  // Year
        { wch: 20 }   // ISBN
    ];

    // Add sheets to workbook
    XLSX.utils.book_append_sheet(wb, detailsWs, "Dettagli Donazione");
    XLSX.utils.book_append_sheet(wb, booksWs, "Libri Donati");

    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });

    function s2ab(s) {
        const buf = new ArrayBuffer(s.length);
        const view = new Uint8Array(buf);
        for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
        return buf;
    }

    const blob = new Blob([s2ab(wbout)], { type: 'application/octet-stream' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `donazione_${formData.cognome}_${formData.nome}.xlsx`;
    a.click();
    window.URL.revokeObjectURL(url);
}
