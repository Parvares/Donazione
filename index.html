function generateExcel(formData, books) {
    // Creiamo il workbook
    const wb = XLSX.utils.book_new();
    
    // Stili per il documento
    const styles = {
        headerStyle: { 
            fill: { fgColor: { rgb: "2C3E50" } },
            font: { color: { rgb: "FFFFFF" }, bold: true, sz: 12 },
            alignment: { horizontal: "center", vertical: "center" }
        },
        subHeaderStyle: {
            fill: { fgColor: { rgb: "3498DB" } },
            font: { color: { rgb: "FFFFFF" }, bold: true, sz: 11 },
            alignment: { horizontal: "left" }
        },
        normalText: {
            font: { sz: 11 },
            alignment: { horizontal: "left", vertical: "center" }
        },
        tableHeader: {
            fill: { fgColor: { rgb: "ECF0F1" } },
            font: { bold: true, sz: 11 },
            alignment: { horizontal: "center", vertical: "center" },
            border: {
                top: { style: "thin" },
                bottom: { style: "thin" },
                left: { style: "thin" },
                right: { style: "thin" }
            }
        }
    };

    // Foglio 1: Dichiarazione di donazione
    const declarationData = [
        [{ v: "DONAZIONE ALLA BIBLIOTECA ELSA MORANTE", s: styles.headerStyle }],
        [""],
        ["Data: " + new Date().toLocaleDateString('it-IT')],
        [""],
        ["DATI DEL DONATORE:"],
        ["Nome e Cognome:", `${formData.nome} ${formData.cognome}`],
        ["Numero Tessera:", formData.tessera || "_______________"],
        ["Telefono:", formData.telefono || "_______________"],
        ["Email:", formData.email],
        [""],
        ["DICHIARAZIONE:"],
        ["Io sottoscritto dichiaro di donare alla Biblioteca le risorse documentarie elencate di seguito"],
        ["e autorizzo la biblioteca a destinarli all'uso che riterrà più opportuno (acquisizione al patrimonio,"],
        ["scambio, dono, bookcrossing o scarto, nel caso in cui, a giudizio insindacabile della biblioteca,"],
        ["i materiali risultino inutilizzabili) senza alcun vincolo per la biblioteca stessa nei miei confronti."],
        [""],
        ["Firma: _______________________"]
    ];

    const ws1 = XLSX.utils.aoa_to_sheet(declarationData);
    ws1['!cols'] = [{ wch: 30 }, { wch: 50 }];
    ws1['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 1 } }];

    // Foglio 2: Lista dei libri
    const headers = ['N°', 'Titolo', 'Autore', 'Editore', 'Anno', 'ISBN'];
    const booksData = books.map((book, index) => [
        index + 1,
        book.title,
        book.author,
        book.publisher,
        book.year,
        book.isbn
    ]);

    const ws2 = XLSX.utils.aoa_to_sheet([
        [{ v: "ELENCO LIBRI DONATI", s: styles.headerStyle }],
        [""],
        headers,
        ...booksData
    ]);

    // Impostazione larghezza colonne per il foglio libri
    ws2['!cols'] = [
        { wch: 5 },  // N°
        { wch: 40 }, // Titolo
        { wch: 30 }, // Autore
        { wch: 25 }, // Editore
        { wch: 10 }, // Anno
        { wch: 15 }  // ISBN
    ];

    // Applica stili alle celle della tabella libri
    const range = XLSX.utils.decode_range(ws2['!ref']);
    for (let R = 0; R <= range.e.r; ++R) {
        for (let C = 0; C <= range.e.c; ++C) {
            const cell_ref = XLSX.utils.encode_cell({r: R, c: C});
            if (!ws2[cell_ref]) continue;
            
            if (R === 0) {
                // Titolo principale
                ws2[cell_ref].s = styles.headerStyle;
            } else if (R === 2) {
                // Header tabella
                ws2[cell_ref].s = styles.tableHeader;
            } else if (R > 2) {
                // Contenuto tabella
                ws2[cell_ref].s = styles.normalText;
            }
        }
    }

    // Merge della cella del titolo
    ws2['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 5 } }];

    // Aggiungi i fogli al workbook
    XLSX.utils.book_append_sheet(wb, ws1, "Dichiarazione");
    XLSX.utils.book_append_sheet(wb, ws2, "Lista Libri");

    // Genera e scarica il file
    const fileName = `donazione_${formData.cognome}_${formData.nome}_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, fileName);
}
