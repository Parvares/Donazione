function generateExcel(formData, books) {
    const documentText = `DONAZIONE ALLA BIBLIOTECA ELSA MORANTE Io sottoscritto ${formData.nome} ${formData.cognome} Tessera n. ${formData.tessera || '_______________'} Tel. ${formData.telefono || '_______________'} e-mail ${formData.email} dono alla Biblioteca le risorse documentarie allegate e autorizzo la biblioteca a destinarli all'uso che riterrà più opportuno (acquisizione al patrimonio, scambio, dono, bookcrossing o scarto, nel caso in cui, a giudizio insindacabile della biblioteca, i materiali risultino inutilizzabili) senza alcun vincolo per la biblioteca stessa nei miei confronti Data: ${new Date().toLocaleDateString('it-IT')}`;

    const wb = XLSX.utils.book_new();
    const ws_data = [
        ['DONAZIONE ALLA BIBLIOTECA ELSA MORANTE'],
        [documentText.split('\n')[0]],
        [''],
        ...documentText.split('\n').slice(1).map(line => [line]),
        [''],
        ['Elenco dei libri donati:'],
        [''],
        ['Titolo', 'Autore', 'Editore', 'Anno', 'ISBN']
    ];
    
    books.forEach(book => {
        ws_data.push([book.title, book.author, book.publisher, book.year, book.isbn]);
    });

    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    
    // Set column widths and styles
    ws['!cols'] = [
        { wch: 40 }, // Title
        { wch: 30 }, // Author
        { wch: 30 }, // Publisher
        { wch: 10 }, // Year
        { wch: 15 }  // ISBN
    ];

    // Apply styles to header row and title
    const headerRow = ws['A1'];
    if (headerRow) {
        headerRow.s = {
            fill: { fgColor: { rgb: "FFFF00" } },
            font: { bold: true },
            alignment: { horizontal: "center" },
            wrap: true
        };
        XLSX.utils.sheet_merge(ws, 'A1:E1');
    }

    ws['A2'].s = {
        wrap: true,
        alignment: { horizontal: "left" }
    };

    // Apply styles to other header cells
    ['A8', 'B8', 'C8', 'D8', 'E8'].forEach(cell => {
        if (ws[cell]) {
            ws[cell].s = {
                fill: { fgColor: { rgb: "CCCCCC" } },
                font: { bold: true },
                border: {
                    top: { style: "thin", color: { rgb: "000000" } },
                    bottom: { style: "thin", color: { rgb: "000000" } },
                    left: { style: "thin", color: { rgb: "000000" } },
                    right: { style: "thin", color: { rgb: "000000" } }
                }
            };
        }
    });

    // Add borders to specific rows
    ws['A2:E2'].s.border = { // Border for donation text row
        top: { style: "thin", color: { rgb: "000000" } },
        bottom: { style: "thin", color: { rgb: "000000" } },
        left: { style: "thin", color: { rgb: "000000" } },
        right: { style: "thin", color: { rgb: "000000" } }
    };

    ws['A8:E8'].s.border = { // Border for book list headers
        // Same border properties as above
    };

    XLSX.utils.book_append_sheet(wb, ws, "Donazione");
    
    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });
    
    function s2ab(s) {
        const buf = new ArrayBuffer(s.length);
        const view = new Uint8Array(buf);
        for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
        return buf;
    }

    const blob = new Blob([s2ab(wbout)], { type: 'application/octet-stream' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `donazione_${formData.cognome}_${formData.nome}.xlsx`;
    a.click();
    window.URL.revokeObjectURL(url);
}
