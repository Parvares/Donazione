<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donazione alla Biblioteca Elsa Morante</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }


        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }


        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }


        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2em;
        }


        h3 {
            color: #34495e;
            margin: 25px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }


        .form-group {
            margin-bottom: 20px;
        }


        label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
            font-weight: 500;
        }


        input[type="text"],
        input[type="tel"],
        input[type="email"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }


        input[type="text"]:focus,
        input[type="tel"]:focus,
        input[type="email"]:focus {
            border-color: #3498db;
            outline: none;
        }


        .book-entry {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            transition: transform 0.2s ease;
        }


        .book-entry:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }


        .book-counter {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #3498db;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }


        .button-group {
            text-align: center;
            margin: 20px 0;
        }


        button {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }


        .add-book {
            background-color: #2ecc71;
            color: white;
            margin: 10px 0;
            width: 100%;
        }


        .add-book:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
        }


        .remove-book {
            background-color: #e74c3c;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
            position: absolute;
            top: 10px;
            right: 10px;
        }


        .remove-book:hover {
            background-color: #c0392b;
        }


        button[type="submit"] {
            background-color: #3498db;
            color: white;
            width: 100%;
            max-width: 300px;
            margin: 20px auto;
            display: block;
        }


        button[type="submit"]:hover {
            background-color: #2980b9;
        }


        .consent-box {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }


        .consent-box label {
            display: flex;
            align-items: center;
            gap: 10px;
        }


        input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }


        .info-box {
            background-color: #e1f5fe;
            border-left: 4px solid #03a9f4;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 5px 5px 0;
        }


        a {
            color: #3498db;
            text-decoration: none;
        }


        a:hover {
            text-decoration: underline;
        }


        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }


            button {
                width: 100%;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Donazione alla Biblioteca Elsa Morante</h1>
        
        <div class="info-box">
            Compila il modulo per donare i tuoi libri alla biblioteca. Tutti i campi contrassegnati con * sono obbligatori.
        </div>


        <form id="donationForm">
            <h3>Dati Personali</h3>
            <div class="form-group">
                <label for="nome">Nome: *</label>
                <input type="text" id="nome" name="nome" required>
            </div>
            
            <div class="form-group">
                <label for="cognome">Cognome: *</label>
                <input type="text" id="cognome" name="cognome" required>
            </div>
            
            <div class="form-group">
                <label for="tessera">Numero Tessera:</label>
                <input type="text" id="tessera" name="tessera">
            </div>


            <div class="form-group">
                <label for="telefono">Telefono:</label>
                <input type="tel" id="telefono" name="telefono">
            </div>
            
            <div class="form-group">
                <label for="email">Email: *</label>
                <input type="email" id="email" name="email" required>
            </div>


            <h3>Libri da donare</h3>
            <div id="bookList"></div>
            
            <div class="consent-box">
                <label>
                    <input type="checkbox" id="accept" name="accept" required>
                    Ho letto e accetto i <a href="https://www.bibliotechediroma.it/sebina/repository/opac/images/Elsa_Morante/TERMINI%20E%20CONDIZIONI.pdf" target="_blank">termini e condizioni</a>
                </label>
            </div>
            
            <button type="submit">Accetta e Genera il Documento</button>
        </form>
    </div>


    <script>
        let bookCount = 0;


        function createBookEntry() {
            const bookDiv = document.createElement('div');
            bookDiv.className = 'book-entry';
            bookCount++;
            bookDiv.innerHTML = 
                <div class="book-counter">${bookCount}</div>
                <div class="form-group">
                    <label>Titolo: *</label>
                    <input type="text" class="book-title" required>
                </div>
                <div class="form-group">
                    <label>Autore:</label>
                    <input type="text" class="book-author">
                </div>
                <div class="form-group">
                    <label>Editore:</label>
                    <input type="text" class="book-publisher">
                </div>
                <div class="form-group">
                    <label>Anno:</label>
                    <input type="text" class="book-year">
                </div>
                <div class="form-group">
                    <label>ISBN:</label>
                    <input type="text" class="book-isbn">
                </div>
                <button type="button" class="remove-book" onclick="removeBook(this)">Rimuovi</button>
                <button type="button" class="add-book" onclick="createBookEntry()">+ Aggiungi Libro</button>
            ;
            document.getElementById('bookList').appendChild(bookDiv);
            updateBookCounters();
        }


        function removeBook(button) {
            button.parentElement.remove();
            bookCount--;
            updateBookCounters();
        }


        function updateBookCounters() {
            const bookEntries = document.querySelectorAll('.book-entry');
            bookEntries.forEach((entry, index) => {
                entry.querySelector('.book-counter').textContent = index + 1;
            });
        }


function generateExcel(formData, books) {
    // Create the document text with better formatting
    const documentText = [
        ['DONAZIONE ALLA BIBLIOTECA ELSA MORANTE'],
        [''],
        ['DATI DEL DONATORE'],
        [''],
        [`Nome e Cognome: ${formData.nome} ${formData.cognome}`],
        [`Tessera n.: ${formData.tessera || '_______________'}`],
        [`Telefono: ${formData.telefono || '_______________'}`],
        [`Email: ${formData.email}`],
        [''],
        ['DICHIARAZIONE'],
        [''],
        ['Io sottoscritto/a dichiaro di donare alla Biblioteca le risorse documentarie allegate'],
        ['e autorizzo la biblioteca a destinarle all\'uso che riterrà più opportuno, inclusi:'],
        ['- acquisizione al patrimonio'],
        ['- scambio'],
        ['- dono'],
        ['- bookcrossing'],
        ['- scarto, nel caso in cui i materiali risultino inutilizzabili'],
        [''],
        ['Dichiaro inoltre di non porre alcun vincolo per la biblioteca nei miei confronti.'],
        [''],
        [`Data: ${new Date().toLocaleDateString('it-IT')}`],
        [''],
        ['ELENCO DEI LIBRI DONATI'],
        ['']
    ];

    const wb = XLSX.utils.book_new();
    
    // Create the worksheet from the formatted text
    const ws_data = [...documentText];
    
    // Add headers for the book list
    ws_data.push(['N.', 'Titolo', 'Autore', 'Editore', 'Anno', 'ISBN']);
    
    // Add books with progressive numbering
    books.forEach((book, index) => {
        ws_data.push([
            index + 1,
            book.title || '',
            book.author || '',
            book.publisher || '',
            book.year || '',
            book.isbn || ''
        ]);
    });

    const ws = XLSX.utils.aoa_to_sheet(ws_data);

    // Style configurations
    const titleStyle = { font: { bold: true, size: 14 }, alignment: { horizontal: 'center' } };
    const headerStyle = { font: { bold: true }, fill: { fgColor: { rgb: "CCE5FF" } } };
    const sectionHeaderStyle = { font: { bold: true }, fill: { fgColor: { rgb: "E6E6E6" } } };
    
    // Apply styles
    ws['!merges'] = [
        { s: { r: 0, c: 0 }, e: { r: 0, c: 5 } }, // Merge first row for title
        { s: { r: 2, c: 0 }, e: { r: 2, c: 5 } }, // Merge "DATI DEL DONATORE"
        { s: { r: 9, c: 0 }, e: { r: 9, c: 5 } }, // Merge "DICHIARAZIONE"
        { s: { r: 23, c: 0 }, e: { r: 23, c: 5 } }  // Merge "ELENCO DEI LIBRI DONATI"
    ];

    // Set column widths
    ws['!cols'] = [
        { wch: 5 },  // N.
        { wch: 40 }, // Titolo
        { wch: 30 }, // Autore
        { wch: 25 }, // Editore
        { wch: 10 }, // Anno
        { wch: 15 }  // ISBN
    ];

    // Apply custom formatting to cells
    for (let i = 0; i < ws_data.length; i++) {
        const row = ws_data[i][0];
        if (row === 'DONAZIONE ALLA BIBLIOTECA ELSA MORANTE') {
            ws[`A${i + 1}`].s = titleStyle;
        } else if (row === 'DATI DEL DONATORE' || row === 'DICHIARAZIONE' || row === 'ELENCO DEI LIBRI DONATI') {
            ws[`A${i + 1}`].s = sectionHeaderStyle;
        }
    }

    // Apply header style to book list headers
    const headerRow = ws_data.length - books.length - 1;
    ['A', 'B', 'C', 'D', 'E', 'F'].forEach(col => {
        ws[`${col}${headerRow}`].s = headerStyle;
    });

    XLSX.utils.book_append_sheet(wb, ws, "Donazione");

    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });

    function s2ab(s) {
        const buf = new ArrayBuffer(s.length);
        const view = new Uint8Array(buf);
        for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
        return buf;
    }

    const blob = new Blob([s2ab(wbout)], { type: 'application/octet-stream' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `donazione_${formData.cognome}_${formData.nome}.xlsx`;
    a.click();
    window.URL.revokeObjectURL(url);
}


        // Create the first book entry when the page loads
        document.addEventListener('DOMContentLoaded', createBookEntry);


        document.getElementById('donationForm').addEventListener('submit', function(event) {
            event.preventDefault();
            
            const nome = document.getElementById('nome').value.trim();
            const cognome = document.getElementById('cognome').value.trim();
            const email = document.getElementById('email').value.trim();
            const tessera = document.getElementById('tessera').value.trim();
            const telefono = document.getElementById('telefono').value.trim();
            const acceptCheckbox = document.getElementById('accept');
            
            if (!nome || !cognome || !email) {
                alert('Per favore compila tutti i campi obbligatori.');
                return;
            }
            
            if (!acceptCheckbox.checked) {
                alert('Devi accettare i termini e le condizioni per procedere.');
                return;
            }


            const books = [];
            document.querySelectorAll('.book-entry').forEach(bookDiv => {
                const book = {
                    title: bookDiv.querySelector('.book-title').value,
                    author: bookDiv.querySelector('.book-author').value,
                    publisher: bookDiv.querySelector('.book-publisher').value,
                    year: bookDiv.querySelector('.book-year').value,
                    isbn: bookDiv.querySelector('.book-isbn').value
                };
                books.push(book);
            });


            if (books.length === 0) {
                alert('Aggiungi almeno un libro alla donazione.');
                return;
            }
            
            const formData = {
                nome,
                cognome,
                email,
                tessera,
                telefono
            };
            
            generateExcel(formData, books);
        });
    </script>
</body>
</html>
