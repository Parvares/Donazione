document.addEventListener('DOMContentLoaded', () => {
    // Existing code for creating book entry and validation
    let bookCount = 0;

    function createBookSearchContainer() {
        const searchContainer = document.createElement('div');
        searchContainer.className = 'book-search-container mb-5';
        searchContainer.innerHTML = `
            <div class="flex items-center gap-2 mb-3">
                <input 
                    type="text" 
                    id="bookSearchInput"
                    placeholder="Cerca un libro per titolo o ISBN"
                    class="w-full px-3 py-2 border-2 border-gray-300 rounded focus:border-blue-500 focus:outline-none text-base"
                />
                <button 
                    id="bookSearchButton"
                    class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600 transition-colors"
                >
                    <i class="fas fa-search"></i>
                </button>
            </div>
            <div id="bookSearchResults" class="book-results border rounded"></div>
        `;
        return searchContainer;
    }

    // Debounce function to prevent too many API calls
    function debounce(func, delay) {
        let timeoutId;
        return function() {
            const context = this;
            const args = arguments;
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
                func.apply(context, args);
            }, delay);
        };
    }

    // Book search functionality
    function setupBookSearch() {
        const searchInput = document.getElementById('bookSearchInput');
        const searchButton = document.getElementById('bookSearchButton');
        const searchResultsContainer = document.getElementById('bookSearchResults');
		
		

// Search books using Google Books API
async function searchBooks() {
    const query = searchInput.value.trim();
    if (!query) {
        searchResultsContainer.innerHTML = '';
        return;
    }

    // Show loading state
    searchResultsContainer.innerHTML = `
        <div class="p-3 text-center text-gray-500">
            Ricerca in corso...
        </div>
    `;

    try {
        // Fetch books from Google Books API
        // Aggiungi la tua API key di Google Books qui
        const apiKey = 'AIzaSyCHJzsPtp8CfKeUag-vvyTxobwR_DmYink'; 
        const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&langRestrict=it&maxResults=5&key=${apiKey}`);
        const data = await response.json();

        // Check if there are results
        if (data.items && data.items.length > 0) {
            // Clear previous results
            searchResultsContainer.innerHTML = '';

            // Create results
            data.items.forEach(book => {
                const volumeInfo = book.volumeInfo;
                const resultDiv = document.createElement('div');
                resultDiv.className = 'p-3 hover:bg-gray-100 cursor-pointer border-b last:border-b-0';
                
                // Prepare book details
                const title = volumeInfo.title || 'Titolo non disponibile';
                const author = volumeInfo.authors ? volumeInfo.authors[0] : 'Autore non disponibile';
                const year = volumeInfo.publishedDate ? volumeInfo.publishedDate.split('-')[0] : '';
                const isbn = volumeInfo.industryIdentifiers 
                    ? volumeInfo.industryIdentifiers.find(id => id.type === 'ISBN_13' || id.type === 'ISBN_10')?.identifier 
                    : '';
                const publisher = volumeInfo.publisher || 'Editore non disponibile';

                resultDiv.innerHTML = `
                    <div class="font-medium">${title}</div>
                    <div class="text-sm text-gray-600">${author} (${year || 'Anno non disponibile'})</div>
                `;

                // Add click event to fill book details
                resultDiv.addEventListener('click', () => {
                    // Find the most recently added book entry
                    const bookEntries = document.querySelectorAll('.book-entry');
                    const latestBookEntry = bookEntries[bookEntries.length - 1];

                    if (latestBookEntry) {
                        // Find input fields
                        const titleInput = latestBookEntry.querySelector('.book-title');
                        const authorInput = latestBookEntry.querySelector('.book-author');
                        const publisherInput = latestBookEntry.querySelector('.book-publisher');
                        const yearInput = latestBookEntry.querySelector('.book-year');
                        const isbnInput = latestBookEntry.querySelector('.book-isbn');

                        // Helper function to set value and trigger validation
                        function setInputValue(input, value) {
                            if (input && value) {
                                input.value = value;
                                // Trigger input and blur events for validation
                                ['input', 'blur'].forEach(eventType => {
                                    const event = new Event(eventType, { bubbles: true });
                                    input.dispatchEvent(event);
                                });
                            }
                        }

                        // Set book details
                        setInputValue(titleInput, title);
                        setInputValue(authorInput, author !== 'Autore non disponibile' ? author : '');
                        setInputValue(publisherInput, publisher !== 'Editore non disponibile' ? publisher : '');
                        setInputValue(yearInput, year);
                        setInputValue(isbnInput, isbn);
                    }

                    // Clear search results
                    searchResultsContainer.innerHTML = '';
                });

                searchResultsContainer.appendChild(resultDiv);
            });
        } else {
            // No results found
            searchResultsContainer.innerHTML = `
                <div class="p-3 text-center text-gray-500">
                    Nessun libro trovato
                </div>
            `;
        }
    } catch (error) {
        console.error('Errore durante la ricerca dei libri:', error);
        searchResultsContainer.innerHTML = `
            <div class="p-3 text-center text-red-500">
                Errore durante la ricerca. Riprova più tardi.
            </div>
        `;
    }
}
		
		

        // Add event listeners
        const debouncedSearch = debounce(searchBooks, 500);
        searchInput.addEventListener('input', debouncedSearch);
        searchButton.addEventListener('click', searchBooks);

        // Allow search on Enter key
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchBooks();
            }
        });
    }

    // Existing code for book entry creation and validation
    function createBookEntry() {
        const bookDiv = document.createElement('div');
        bookDiv.className = 'book-entry relative bg-gray-50 border border-gray-200 rounded-lg p-5 mb-5 hover:transform hover:-translate-y-1 transition-transform';
        bookCount++;

        bookDiv.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <span class="book-counter flex items-center justify-center w-6 h-6 rounded-full text-white font-semibold text-sm" style="background-color: rgb(34, 197, 94)">${bookCount}</span>
                ${bookCount > 1 ? `
                    <button type="button" class="remove-book-btn" onclick="removeBook(this)">✖</button>
                ` : ''}
            </div>
            
            <div class="mb-5">
                <label class="block mb-1 text-slate-700 font-medium">Titolo: *</label>
                <input type="text" class="book-title w-full px-3 py-2 border-2 border-gray-300 rounded focus:border-blue-500 focus:outline-none text-base" required>
                <p class="hidden error-message text-sm text-red-500 mt-1">Il titolo è obbligatorio</p>
            </div>
            <div class="mb-5">
                <label class="block mb-1 text-slate-700 font-medium">Autore:</label>
                <input type="text" class="book-author w-full px-3 py-2 border-2 border-gray-300 rounded focus:border-blue-500 focus:outline-none text-base">
            </div>
            <div class="mb-5">
                <label class="block mb-1 text-slate-700 font-medium">Editore:</label>
                <input type="text" class="book-publisher w-full px-3 py-2 border-2 border-gray-300 rounded focus:border-blue-500 focus:outline-none text-base">
            </div>

            <div class="mb-5">
                <label class="block mb-1 text-slate-700 font-medium">Anno:</label>
                <input type="number" min="1400" max="2024" class="book-year w-full px-3 py-2 border-2 border-gray-300 rounded focus:border-blue-500 focus:outline-none text-base">
                <p class="hidden error-message text-sm text-red-500 mt-1">Anno non valido</p>
            </div>

            <div class="mb-5">
                <div class="flex items-center gap-1">
                    <label class="block text-slate-700 font-medium">ISBN (raccomandato):</label>
                    <div class="relative group -mt-1">
                        <i class="fa-solid fa-circle-info text-gray-500 hover:text-gray-700 transition-colors text-sm"></i>
                        <div class="invisible group-hover:visible absolute left-1/2 -translate-x-1/2 bottom-full mb-2 px-3 py-2 bg-white border border-gray-200 text-gray-700 text-sm rounded-lg w-64 shadow-lg z-10">
                            <div class="absolute left-1/2 -translate-x-1/2 bottom-0 translate-y-full w-0 h-0 border-8 border-transparent border-t-white"></div>
                            <div class="absolute left-1/2 -translate-x-1/2 bottom-0 translate-y-full w-0 h-0 border-[9px] border-transparent border-t-gray-200"></div>
                            L'ISBN (International Standard Book Number) è un codice numerico di 10 o 13 cifre che identifica univocamente un libro. Lo trovi sul retro del libro sopra al codice a barre o nella pagina del copyright.
                        </div>
                    </div>
                </div>
                <input type="tel" inputmode="numeric" class="book-isbn w-full px-3 py-2 border-2 border-gray-300 rounded focus:border-blue-500 focus:outline-none text-base" maxlength="13">
                <p class="hidden error-message text-sm text-red-500 mt-1">ISBN non valido</p>
            </div>
            
            <button type="button" class="add-book-btn" onclick="createBookEntry()">+ Aggiungi Libro</button>
        `;

        const inputs = bookDiv.querySelectorAll('input');
        inputs.forEach(input => {
            input.addEventListener('input', () => {
                if (input.classList.contains('book-year') || input.classList.contains('book-isbn')) {
                    validateBookField(input);
                }
            });
            input.addEventListener('blur', () => {
                if (input.classList.contains('book-year') || input.classList.contains('book-isbn')) {
                    validateBookField(input);
                }
            });
        });

        document.getElementById('bookList').appendChild(bookDiv);
        updateBookCounters();
    }

    // Existing validation and utility functions
    function validateBookField(input) {
        const value = input.value.trim();
        let isValid = true;

        if (input.hasAttribute('required') && !value) {
            showError(input, 'Questo campo è obbligatorio');
            isValid = false;
        } else if (input.classList.contains('book-year')) {
            const currentYear = new Date().getFullYear();
            
            // Allow partial input without showing error
            if (value) {
                // Check if input is currently being typed (less than 4 digits)
                if (value.length < 4) {
                    return true; // Don't validate while typing
                }

                const year = parseInt(value);
                
                // Validate fully entered year
                if (!Number.isInteger(year) || year < 1900 || year > currentYear) {
                    showError(input, `L'anno deve essere un numero di 4 cifre compreso tra 1900 e ${currentYear}`);
                    input.value = value.slice(0, 4); // Tronca a 4 cifre
                    isValid = false;
                }
            }
        } else if (input.classList.contains('book-isbn')) {
            if (value && !/^(?:\d{10}|\d{13})$/.test(value)) {
                showError(input, 'ISBN deve essere di 10 o 13 cifre');
                isValid = false;
            }
        }

        if (isValid) {
            hideError(input);
        }

        return isValid;
    }

    function removeBook(button) {
        const bookEntry = button.closest('.book-entry');
        if (bookEntry) {
            bookEntry.remove();
            bookCount--;
            updateBookCounters();
        }
    }

    function updateBookCounters() {
        const bookEntries = document.querySelectorAll('.book-entry');
        bookEntries.forEach((entry, index) => {
            entry.querySelector('.book-counter').textContent = index + 1;
        });
    }

    // Existing input validation functions
    function showError(input, message) {
        const errorElement = input.parentElement.querySelector('.error-message');
        if (errorElement) {
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
            input.classList.add('border-red-500');
            input.classList.remove('border-gray-300', 'focus:border-blue-500');
        }
    }

    function hideError(input) {
        const errorElement = input.parentElement.querySelector('.error-message');
        if (errorElement) {
            errorElement.classList.add('hidden');
            input.classList.remove('border-red-500');
            input.classList.add('border-gray-300', 'focus:border-blue-500');
        }
    }

    // Create first book entry and set up book search
    createBookEntry();

    // Insert book search container at the top of the book list
    const bookList = document.getElementById('bookList');
    if (bookList) {
        const searchContainer = createBookSearchContainer();
        bookList.insertBefore(searchContainer, bookList.firstChild);
    }

    // Setup book search functionality
    setupBookSearch();

    // Existing input validation setup
    const inputs = document.querySelectorAll('input');
    inputs.forEach(input => {
        if (input.id) {
            input.addEventListener('input', () => validateField(input));
            input.addEventListener('blur', () => validateField(input));
        }
    });
});
