let bookCount = 0;

function createBookEntry() {
    const bookDiv = document.createElement('div');
    bookDiv.className = 'book-entry';
    bookCount++;
    bookDiv.innerHTML = `
        <div class="book-counter">${bookCount}</div>
        <div class="form-group">
            <label>Titolo: *</label>
            <input type="text" class="book-title" required>
        </div>
        <div class="form-group">
            <label>Autore:</label>
            <input type="text" class="book-author">
        </div>
        <div class="form-group">
            <label>Editore:</label>
            <input type="text" class="book-publisher">
        </div>
        <div class="form-group">
            <label>Anno:</label>
            <input type="text" class="book-year">
        </div>
        <div class="form-group">
            <label>ISBN:</label>
            <input type="text" class="book-isbn">
        </div>
        <button type="button" class="remove-book" onclick="removeBook(this)">Rimuovi</button>
        <button type="button" class="add-book" onclick="createBookEntry()">+ Aggiungi Libro</button>
    `;
    document.getElementById('bookList').appendChild(bookDiv);
    updateBookCounters();
}

function removeBook(button) {
    button.parentElement.remove();
    bookCount--;
    updateBookCounters();
}

function updateBookCounters() {
    const bookEntries = document.querySelectorAll('.book-entry');
    bookEntries.forEach((entry, index) => {
        entry.querySelector('.book-counter').textContent = index + 1;
    });
}

function generateExcel(formData, books) {
    const wb = XLSX.utils.book_new();
    
    // Donation Details Sheet
    const detailsData = [
        ['Donazione alla Biblioteca Elsa Morante'],
        [],
        ['DATI DONATORE'],
        ['Nome', formData.nome],
        ['Cognome', formData.cognome],
        ['Numero Tessera', formData.tessera || 'Non specificato'],
        ['Telefono', formData.telefono || 'Non specificato'],
        ['Email', formData.email],
        [],
        ['Data Donazione', new Date().toLocaleDateString('it-IT')]
    ];

    const detailsWs = XLSX.utils.aoa_to_sheet(detailsData);

    // Impostazioni di stile per il foglio dei dettagli
    detailsWs['!cols'] = [{ wch: 20 }, { wch: 30 }];

    // Books Sheet
    const booksData = [
        ['Elenco Libri Donati'],
        [],
        ['Titolo', 'Autore', 'Editore', 'Anno', 'ISBN']
    ];

    books.forEach(book => {
        booksData.push([
            book.title || 'Non specificato', 
            book.author || 'Non specificato', 
            book.publisher || 'Non specificato', 
            book.year || 'Non specificato', 
            book.isbn || 'Non specificato'
        ]);
    });

    const booksWs = XLSX.utils.aoa_to_sheet(booksData);

    // Impostazioni di stile per il foglio dei libri
    booksWs['!cols'] = [
        { wch: 40 },  // Titolo
        { wch: 30 },  // Autore
        { wch: 30 },  // Editore
        { wch: 10 },  // Anno
        { wch: 20 }   // ISBN
    ];

    // Aggiungi i fogli al workbook
    XLSX.utils.book_append_sheet(wb, detailsWs, "Dettagli Donazione");
    XLSX.utils.book_append_sheet(wb, booksWs, "Libri Donati");

    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });

    function s2ab(s) {
        const buf = new ArrayBuffer(s.length);
        const view = new Uint8Array(buf);
        for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
        return buf;
    }

    const blob = new Blob([s2ab(wbout)], { type: 'application/octet-stream' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `donazione_${formData.cognome}_${formData.nome}.xlsx`;
    a.click();
    window.URL.revokeObjectURL(url);
}

// Crea la prima voce di libro quando la pagina si carica
document.addEventListener('DOMContentLoaded', createBookEntry);

document.getElementById('donationForm').addEventListener('submit', function(event) {
    event.preventDefault();
    
    const nome = document.getElementById('nome').value.trim();
    const cognome = document.getElementById('cognome').value.trim();
    const email = document.getElementById('email').value.trim();
    const tessera = document.getElementById('tessera').value.trim();
    const telefono = document.getElementById('telefono').value.trim();
    const acceptCheckbox = document.getElementById('accept');
    
    if (!nome || !cognome || !email) {
        alert('Per favore compila tutti i campi obbligatori.');
        return;
    }
    
    if (!acceptCheckbox.checked) {
        alert('Devi accettare i termini e le condizioni per procedere.');
        return;
    }

    const books = [];
    document.querySelectorAll('.book-entry').forEach(bookDiv => {
        const book = {
            title: bookDiv.querySelector('.book-title').value,
            author: bookDiv.querySelector('.book-author').value,
            publisher: bookDiv.querySelector('.book-publisher').value,
            year: bookDiv.querySelector('.book-year').value,
            isbn: bookDiv.querySelector('.book-isbn').value
        };
        books.push(book);
    });

    if (books.length === 0) {
        alert('Aggiungi almeno un libro alla donazione.');
        return;
    }
    
    const formData = {
        nome,
        cognome,
        email,
        tessera,
        telefono
    };
    
    generateExcel(formData, books);
});
