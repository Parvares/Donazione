function generateExcel(formData, books) {
    // Create the document text with better formatting
    const documentText = [
        ['DONAZIONE ALLA BIBLIOTECA ELSA MORANTE'],
        [''],
        ['DATI DEL DONATORE'],
        [''],
        [`Nome e Cognome: ${formData.nome} ${formData.cognome}`],
        [`Tessera n.: ${formData.tessera || '_______________'}`],
        [`Telefono: ${formData.telefono || '_______________'}`],
        [`Email: ${formData.email}`],
        [''],
        ['DICHIARAZIONE'],
        [''],
        ['Io sottoscritto/a dichiaro di donare alla Biblioteca le risorse documentarie allegate'],
        ['e autorizzo la biblioteca a destinarle all\'uso che riterrà più opportuno, inclusi:'],
        ['- acquisizione al patrimonio'],
        ['- scambio'],
        ['- dono'],
        ['- bookcrossing'],
        ['- scarto, nel caso in cui i materiali risultino inutilizzabili'],
        [''],
        ['Dichiaro inoltre di non porre alcun vincolo per la biblioteca nei miei confronti.'],
        [''],
        [`Data: ${new Date().toLocaleDateString('it-IT')}`],
        [''],
        ['ELENCO DEI LIBRI DONATI'],
        ['']
    ];

    const wb = XLSX.utils.book_new();
    
    // Create the worksheet from the formatted text
    const ws_data = [...documentText];
    
    // Add headers for the book list
    ws_data.push(['N.', 'Titolo', 'Autore', 'Editore', 'Anno', 'ISBN']);
    
    // Add books with progressive numbering
    books.forEach((book, index) => {
        ws_data.push([
            index + 1,
            book.title || '',
            book.author || '',
            book.publisher || '',
            book.year || '',
            book.isbn || ''
        ]);
    });

    const ws = XLSX.utils.aoa_to_sheet(ws_data);

    // Style configurations
    const titleStyle = { font: { bold: true, size: 14 }, alignment: { horizontal: 'center' } };
    const headerStyle = { font: { bold: true }, fill: { fgColor: { rgb: "CCE5FF" } } };
    const sectionHeaderStyle = { font: { bold: true }, fill: { fgColor: { rgb: "E6E6E6" } } };
    
    // Apply styles
    ws['!merges'] = [
        { s: { r: 0, c: 0 }, e: { r: 0, c: 5 } }, // Merge first row for title
        { s: { r: 2, c: 0 }, e: { r: 2, c: 5 } }, // Merge "DATI DEL DONATORE"
        { s: { r: 9, c: 0 }, e: { r: 9, c: 5 } }, // Merge "DICHIARAZIONE"
        { s: { r: 23, c: 0 }, e: { r: 23, c: 5 } }  // Merge "ELENCO DEI LIBRI DONATI"
    ];

    // Set column widths
    ws['!cols'] = [
        { wch: 5 },  // N.
        { wch: 40 }, // Titolo
        { wch: 30 }, // Autore
        { wch: 25 }, // Editore
        { wch: 10 }, // Anno
        { wch: 15 }  // ISBN
    ];

    // Apply custom formatting to cells
    for (let i = 0; i < ws_data.length; i++) {
        const row = ws_data[i][0];
        if (row === 'DONAZIONE ALLA BIBLIOTECA ELSA MORANTE') {
            ws[`A${i + 1}`].s = titleStyle;
        } else if (row === 'DATI DEL DONATORE' || row === 'DICHIARAZIONE' || row === 'ELENCO DEI LIBRI DONATI') {
            ws[`A${i + 1}`].s = sectionHeaderStyle;
        }
    }

    // Apply header style to book list headers
    const headerRow = ws_data.length - books.length - 1;
    ['A', 'B', 'C', 'D', 'E', 'F'].forEach(col => {
        ws[`${col}${headerRow}`].s = headerStyle;
    });

    XLSX.utils.book_append_sheet(wb, ws, "Donazione");

    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });

    function s2ab(s) {
        const buf = new ArrayBuffer(s.length);
        const view = new Uint8Array(buf);
        for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
        return buf;
    }

    const blob = new Blob([s2ab(wbout)], { type: 'application/octet-stream' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `donazione_${formData.cognome}_${formData.nome}.xlsx`;
    a.click();
    window.URL.revokeObjectURL(url);
}
