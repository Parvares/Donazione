<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donazione alla Biblioteca Elsa Morante</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f5f5f5; color: #333; line-height: 1.6; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 30px; font-size: 2.2em; }
        h3 { color: #34495e; margin: 25px 0 15px 0; padding-bottom: 10px; border-bottom: 2px solid #eee; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; color: #2c3e50; font-weight: 500; }
        input[type="text"], input[type="tel"], input[type="email"] { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px; transition: border-color 0.3s ease; }
        input[type="text"]:focus, input[type="tel"]:focus, input[type="email"]:focus { border-color: #3498db; outline: none; }
        .book-entry { background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 20px; margin-bottom: 20px; position: relative; transition: transform 0.2s ease; }
        .book-entry:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .book-counter { position: absolute; top: -10px; right: -10px; background: #3498db; color: white; width: 25px; height: 25px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; }
        .button-group { text-align: center; margin: 20px 0; }
        button { padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 500; transition: all 0.3s ease; }
        .add-book { background-color: #2ecc71; color: white; margin: 10px 0; width: 100%; }
        .add-book:hover { background-color: #27ae60; transform: translateY(-2px); }
        .remove-book { background-color: #e74c3c; color: white; padding: 8px 16px; font-size: 14px; position:absolute ; top :10 px ; right :10 px ; }
        .remove-book:hover { background-color:# c0392b ;}
        button[type="submit"] { background-color:#3498db ; color:white ; width :100 % ; max-width :300 px ; margin :20 px auto ; display:block ;}
        button[type="submit"]:hover{ background-color:#2980b9;}
        .consent-box{ background-color:#f8f9fa ; padding :15 px ; border-radius :5 px ; margin :20 px ;
            } 
            .consent-box label{ display:flex ; align-items:center ; gap :10 px ;
            } 
            input[type="checkbox"]{ width :18 px ; height :18 px ;
            } 
            .info-box{ background-color:#e1f5fe ; border-left :4 px solid #03a9f4 ; padding :15 px ; margin-bottom :20 px ;
                border-radius :0 5 px ;
                } 
                a{ color:#3498db ; text-decoration:none ;
                } 
                a:hover{ text-decoration :underline ;
                } 
                @media (max-width :600 px) {
                    .container{ padding :15 px ;
                    } 
                    button{ width :100 % ; margin-bottom :10 px ;
                    } 
                }
    </style>
</head>
<body>
    <div class="container">
        <h1>Donazione alla Biblioteca Elsa Morante</h1>
        <div class="info-box">Compila il modulo per donare i tuoi libri alla biblioteca. Tutti i campi contrassegnati con * sono obbligatori.</div>
        <form id="donationForm">
            <h3>Dati Personali</h3>
            <div class="form-group">
                <label for="nome">Nome:* </label>
                <input type="text" id="nome" name="nome" required>
            </div>
            <div class="form-group">
                <label for="cognome">Cognome:* </label>
                <input type="text" id="cognome" name="cognome" required>
            </div>
            <div class="form-group">
                <label for="tessera">Numero Tessera:</label>
                <input type="text" id="tessera" name="tessera">
            </div>
            <div class="form-group">
                <label for="telefono">Telefono:</label>
                <input type="tel" id="telefono" name="telefono">
            </div>
            <div class="form-group">
                <label for="email">Email:* </label>
                <input type="email" id="email" name="email" required>
            </div>
            <h3>Libri da donare</h3>
            <div id="bookList"></div>
            <div class="consent-box">
                <label><input type="checkbox" id="accept" name="accept" required> Ho letto e accetto i
                    <a href="https://www.bibliotechediroma.it/sebina/repository/opac/images/Elsa_Morante/TERMINI%20E%20CONDIZIONI.pdf"
                        target="_blank">termini e condizioni</a></label>
            </div>
            <button type="submit">Accetta e Genera il Documento</button>
        </form>
    </div>

    <script>
        let bookCount = 0;

        function createBookEntry() {
            const bookDiv = document.createElement('div');
            bookDiv.className = 'book-entry';
            bookCount++;
            bookDiv.innerHTML = `
                <div class="book-counter">${bookCount}</div>
                <div class="form-group">
                    <label>Titolo:* </label>
                    <input type="text" class="book-title" required>
                </div>
                <div class="form-group">
                    <label>Autore:</label>
                    <input type="text" class="book-author">
                </div>
                <div class="form-group">
                    <label>Editore:</label>
                    <input type="text" class="book-publisher">
                </div>
                <div class="form-group">
                    <label>Anno:</label>
                    <input type="text" class="book-year">
                </div>
                <div class="form-group">
                    <label>ISBN:</label>
                    <input type="text" class="book-isbn">
                </div>
                <button type='button' class='remove-book' onclick='removeBook(this)'>Rimuovi</button>`;
                
            document.getElementById('bookList').appendChild(bookDiv);
            updateBookCounters();
        }

        function removeBook(button) {
            button.parentElement.remove();
            bookCount--;
            updateBookCounters();
        }

        function updateBookCounters() {
            const bookEntries = document.querySelectorAll('.book-entry');
            bookEntries.forEach((entry, index) => {
                entry.querySelector('.book-counter').textContent = index + 1;
            });
        }

        function generateExcel(formData, books) {
            const wb = XLSX.utils.book_new();
            
            // Preparazione dei dati per il documento
            const documentData = [
              [{ v:'Donazione alla Biblioteca Elsa Morante', s:{ font:{ bold:true } }}],
              [],
              [{ v:'Dati del Donatore', s:{ font:{ bold:true } }}],
              [{ v:'Nome', s:{ font:{ bold:true } }}, formData.nome],
              [{ v:'Cognome', s:{ font:{ bold:true } }}, formData.cognome],
              [{ v:'Numero Tessera', s:{ font:{ bold:true } }}, formData.tessera || 'Non specificato'],
              [{ v:'Telefono', s:{ font:{ bold:true } }}, formData.telefono || 'Non specificato'],
              [{ v:'Email', s:{ font:{ bold:true } }}, formData.email],
              [],
              [{ v:'Dichiarazione', s:{ font:{ bold:true } }}],
              ['Io sottoscritto dichiaro di donare alla Biblioteca le risorse documentarie allegate e autorizzo la biblioteca a destinarli all\'uso che riterrà più opportuno.'],
              [],
              ['Data Donazione', new Date().toLocaleDateString('it-IT')],
              [],
              [{ v:'Elenco Libri Donati', s:{ font:{ bold:true } }}],
              [{ v:'Titolo', s:{ font:{ bold:true } }},
               { v:'Autore', s:{ font:{ bold:true } }},
               { v:'Editore', s:{ font:{ bold:true } }},
               { v:'Anno', s:{ font:{ bold:true } }},
               { v:'ISBN', s:{ font:{ bold:true } }}]
          ];

          // Aggiunta dei libri alla lista
          books.forEach(book => {
              documentData.push([
                  book.title || 'Non specificato',
                  book.author || 'Non specificato',
                  book.publisher || 'Non specificato',
                  book.year || 'Non specificato',
                  book.isbn || 'Non specificato'
              ]);
          });

          // Creazione del foglio
          const sheet = XLSX.utils.aoa_to_sheet(documentData);

          // Impostazione larghezza colonne
          sheet['!cols'] = [
              { wch :40 }, // Prima colonna
              { wch :30 }, // Seconda colonna (per i libri)
              { wch :30 },
              { wch :30 },
              { wch :15 },
              { wch :20 }
          ];

          // Aggiunta del foglio al workbook
          XLSX.utils.book_append_sheet(wb, sheet, "Donazione Libri");

          // Generazione e download del file
          const wbout = XLSX.write(wb, { bookType:'xlsx', type:'binary' });
          
          function s2ab(s) {
              const buf = new ArrayBuffer(s.length);
              const view = new Uint8Array(buf);
              for (let i = 0;i<s.length;i++) view[i] = s.charCodeAt(i)&0xFF;
              return buf;
          }

          const blob = new Blob([s2ab(wbout)], { type:'application/octet-stream' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `donazione_${formData.cognome}_${formData.nome}.xlsx`;
          a.click();
          window.URL.revokeObjectURL(url);
      }

      // Create the first book entry when the page loads
      document.addEventListener('DOMContentLoaded', createBookEntry);
      document.getElementById('donationForm').addEventListener('submit', function(event) {
          event.preventDefault();
          
          const nome = document.getElementById('nome').value.trim();
          const cognome = document.getElementById('cognome').value.trim();
          const email = document.getElementById('email').value.trim();
          const tessera = document.getElementById('tessera').value.trim();
          const telefono = document.getElementById('telefono').value.trim();
          const acceptCheckbox = document.getElementById('accept');

          if (!nome || !cognome || !email) {
              alert('Per favore compila tutti i campi obbligatori.');
              return;
          }

          if (!acceptCheckbox.checked) {
              alert('Devi accettare i termini e le condizioni per procedere.');
              return;
          }

          const books = [];
          
          document.querySelectorAll('.book-entry').forEach(bookDiv => {
              const book = {
                  title   : bookDiv.querySelector('.book-title').value,
                  author   : bookDiv.querySelector('.book-author').value,
                  publisher   : bookDiv.querySelector('.book-publisher').value,
                  year   : bookDiv.querySelector('.book-year').value,
                  isbn   : bookDiv.querySelector('.book-isbn').value
              };
              
              books.push(book);
          });

          if (books.length === 0) {
              alert('Aggiungi almeno un libro alla donazione.');
              return;
          }

          const formData = { nome, cognome, email, tessera, telefono };
          
          generateExcel(formData, books);
      });
    </script>

</body>
</html>
