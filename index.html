function generateExcel(formData, books) {
    const wb = XLSX.utils.book_new();
    
    // Foglio di copertina con informazioni del donatore
    const coverSheetData = [
        ['DONAZIONE ALLA BIBLIOTECA ELSA MORANTE'],
        [],
        ['Dati del Donatore'],
        ['Nome', formData.nome],
        ['Cognome', formData.cognome],
        ['Tessera n.', formData.tessera || 'Non specificato'],
        ['Telefono', formData.telefono || 'Non specificato'],
        ['Email', formData.email],
        [],
        ['Data Donazione', new Date().toLocaleDateString('it-IT')],
        [],
        ['Dichiarazione'],
        ['Il sottoscritto dichiara di donare alla Biblioteca le risorse documentarie allegate,'],
        ['autorizzando la biblioteca a destinarle all\'uso ritenuto piÃ¹ opportuno.']
    ];

    const coverSheet = XLSX.utils.aoa_to_sheet(coverSheetData);
    
    // Stili personalizzati
    coverSheet['!cols'] = [{ wch: 20 }, { wch: 40 }];
    coverSheet['A1'].s = { 
        font: { bold: true, sz: 16, color: { rgb: "0000FF" } },
        alignment: { horizontal: "center" }
    };
    coverSheet['A3'].s = { 
        font: { bold: true },
        alignment: { horizontal: "left" }
    };

    // Foglio dei libri
    const booksSheetData = [
        ['Elenco dei Libri Donati'],
        [],
        ['Titolo', 'Autore', 'Editore', 'Anno', 'ISBN']
    ];

    // Aggiunge i libri alla lista
    books.forEach(book => {
        booksSheetData.push([
            book.title || 'Non specificato', 
            book.author || 'Non specificato', 
            book.publisher || 'Non specificato', 
            book.year || 'Non specificato', 
            book.isbn || 'Non specificato'
        ]);
    });

    const booksSheet = XLSX.utils.aoa_to_sheet(booksSheetData);
    
    // Imposta larghezza colonne e stili
    booksSheet['!cols'] = [
        { wch: 40 },  // Titolo
        { wch: 30 },  // Autore
        { wch: 30 },  // Editore
        { wch: 10 },  // Anno
        { wch: 20 }   // ISBN
    ];
    booksSheet['A1'].s = { 
        font: { bold: true, sz: 14, color: { rgb: "0000FF" } },
        alignment: { horizontal: "center" }
    };
    booksSheet['A3'].s = { 
        font: { bold: true },
        fill: { fgColor: { rgb: "E0E0E0" } }
    };

    // Aggiungi i fogli al workbook
    XLSX.utils.book_append_sheet(wb, coverSheet, "Dettagli Donazione");
    XLSX.utils.book_append_sheet(wb, booksSheet, "Libri Donati");

    // Genera e scarica il file
    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });

    function s2ab(s) {
        const buf = new ArrayBuffer(s.length);
        const view = new Uint8Array(buf);
        for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
        return buf;
    }

    const blob = new Blob([s2ab(wbout)], { type: 'application/octet-stream' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `donazione_${formData.cognome}_${formData.nome}.xlsx`;
    a.click();
    window.URL.revokeObjectURL(url);
}
