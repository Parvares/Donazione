<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donazione alla Biblioteca Elsa Morante</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* ... (mantenere gli stili precedenti fino a .book-entry) ... */
        .book-entry {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            transition: transform 0.2s ease;
        }

        .book-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
        }

        .add-book-inline {
            background-color: #2ecc71;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
        }

        .add-book-inline:hover {
            background-color: #27ae60;
        }

        .remove-book {
            background-color: #e74c3c;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
        }

        .remove-book:hover {
            background-color: #c0392b;
        }

        .terms-link {
            color: #3498db;
            text-decoration: none;
            font-weight: 500;
        }

        .terms-link:hover {
            text-decoration: underline;
        }

        /* ... (mantenere gli altri stili precedenti) ... */
    </style>
</head>
<body>
    <div class="container">
        <!-- ... (mantenere l'header e l'info-box precedenti) ... -->
        <form id="donationForm">
            <!-- ... (mantenere i campi personali precedenti) ... -->

            <h3>Libri da donare</h3>
            <div class="button-group">
                <button type="button" id="addBook">+ Aggiungi Libro</button>
            </div>
            
            <div id="bookList"></div>
            
            <div class="consent-box">
                <label>
                    <input type="checkbox" id="accept" name="accept" required>
                    Ho letto e accetto i <a href="https://www.bibliotechediroma.it/sebina/repository/opac/images/Elsa_Morante/TERMINI%20E%20CONDIZIONI.pdf" target="_blank" class="terms-link">termini e condizioni</a>
                </label>
            </div>
            
            <button type="submit">Accetta e Genera il Documento</button>
        </form>
    </div>

    <script>
        function createBookEntry() {
            const bookDiv = document.createElement('div');
            bookDiv.className = 'book-entry';
            bookCount++;
            bookDiv.innerHTML = `
                <div class="book-counter">${bookCount}</div>
                <div class="book-actions">
                    <button type="button" class="add-book-inline" onclick="createBookEntry()">+ Aggiungi</button>
                    <button type="button" class="remove-book" onclick="removeBook(this)">Rimuovi</button>
                </div>
                <div class="form-group">
                    <label>Titolo: *</label>
                    <input type="text" class="book-title" required>
                </div>
                <div class="form-group">
                    <label>Autore:</label>
                    <input type="text" class="book-author">
                </div>
                <div class="form-group">
                    <label>Editore:</label>
                    <input type="text" class="book-publisher">
                </div>
                <div class="form-group">
                    <label>Anno:</label>
                    <input type="text" class="book-year">
                </div>
                <div class="form-group">
                    <label>ISBN:</label>
                    <input type="text" class="book-isbn">
                </div>
            `;
            document.getElementById('bookList').appendChild(bookDiv);
            updateBookCounters();
        }

        function generateExcel(formData, books) {
            const wb = XLSX.utils.book_new();
            
            // Stili per il foglio Excel
            const styles = {
                header: { font: { bold: true, size: 14 }, alignment: { horizontal: 'center' } },
                subHeader: { font: { bold: true }, alignment: { horizontal: 'left' } },
                normal: { font: { size: 11 }, alignment: { horizontal: 'left' } },
                table_header: { 
                    font: { bold: true, color: { rgb: "FFFFFF" } },
                    fill: { fgColor: { rgb: "4F81BD" } },
                    alignment: { horizontal: 'center' }
                }
            };

            const ws_data = [
                [{ v: 'DONAZIONE ALLA BIBLIOTECA ELSA MORANTE', s: styles.header }],
                [''],
                [{ v: `Io sottoscritto ${formData.nome} ${formData.cognome}`, s: styles.subHeader }],
                [{ v: `Tessera n. ${formData.tessera || '_______________'}`, s: styles.normal }],
                [{ v: `Tel. ${formData.telefono || '_______________'}`, s: styles.normal }],
                [{ v: `e-mail ${formData.email}`, s: styles.normal }],
                [''],
                [{ 
                    v: 'dono alla Biblioteca le risorse documentarie allegate e autorizzo la biblioteca a destinarli all'uso che riterrà più opportuno (acquisizione al patrimonio, scambio, dono, bookcrossing o scarto, nel caso in cui, a giudizio insindacabile della biblioteca, i materiali risultino inutilizzabili) senza alcun vincolo per la biblioteca stessa nei miei confronti',
                    s: styles.normal
                }],
                [''],
                [{ v: `Data: ${new Date().toLocaleDateString('it-IT')}`, s: styles.normal }],
                [''],
                [{ v: 'Elenco dei libri donati:', s: styles.subHeader }],
                [''],
                [
                    { v: 'Titolo', s: styles.table_header },
                    { v: 'Autore', s: styles.table_header },
                    { v: 'Editore', s: styles.table_header },
                    { v: 'Anno', s: styles.table_header },
                    { v: 'ISBN', s: styles.table_header }
                ]
            ];

            books.forEach(book => {
                ws_data.push([
                    { v: book.title, s: styles.normal },
                    { v: book.author, s: styles.normal },
                    { v: book.publisher, s: styles.normal },
                    { v: book.year, s: styles.normal },
                    { v: book.isbn, s: styles.normal }
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(ws_data);

            ws['!cols'] = [
                { wch: 35 }, // Titolo
                { wch: 25 }, // Autore
                { wch: 25 }, // Editore
                { wch: 15 }, // Anno
                { wch: 20 }  // ISBN
            ];

            XLSX.utils.book_append_sheet(wb, ws, "Donazione");

            // ... (resto del codice per generare e scaricare il file Excel)
        }

        // ... (mantenere il resto del codice JavaScript precedente) ...
    </script>
</body>
</html>
