<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donazione alla Biblioteca Elsa Morante</title>
    <!-- Includi xlsx-style per supportare la formattazione avanzata -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx-style/0.18.7/xlsx-style.full.min.js"></script>
    <style>
        /* Il tuo codice CSS esistente */
    </style>
</head>
<body>
    <div class="container">
        <h1>Donazione alla Biblioteca Elsa Morante</h1>
        
        <div class="info-box">
            Compila il modulo per donare i tuoi libri alla biblioteca. Tutti i campi contrassegnati con * sono obbligatori.
        </div>

        <form id="donationForm">
            <h3>Dati Personali</h3>
            <!-- Campi del modulo -->
            <div class="form-group">
                <label for="nome">Nome: *</label>
                <input type="text" id="nome" name="nome" required>
            </div>
            <!-- Altri campi del modulo -->
            
            <h3>Libri da donare</h3>
            <div id="bookList"></div>
            
            <div class="consent-box">
                <label>
                    <input type="checkbox" id="accept" name="accept" required>
                    Ho letto e accetto i <a href="https://www.bibliotechediroma.it/sebina/repository/opac/images/Elsa_Morante/TERMINI%20E%20CONDIZIONI.pdf" target="_blank">termini e condizioni</a>
                </label>
            </div>
            
            <button type="submit">Accetta e Genera il Documento</button>
        </form>
    </div>

    <script>
        let bookCount = 0;

        function createBookEntry() {
            const bookDiv = document.createElement('div');
            bookDiv.className = 'book-entry';
            bookCount++;
            bookDiv.innerHTML = `
                <div class="book-counter">${bookCount}</div>
                <div class="form-group">
                    <label>Titolo: *</label>
                    <input type="text" class="book-title" required>
                </div>
                <div class="form-group">
                    <label>Autore:</label>
                    <input type="text" class="book-author">
                </div>
                <div class="form-group">
                    <label>Editore:</label>
                    <input type="text" class="book-publisher">
                </div>
                <div class="form-group">
                    <label>Anno:</label>
                    <input type="text" class="book-year">
                </div>
                <div class="form-group">
                    <label>ISBN:</label>
                    <input type="text" class="book-isbn">
                </div>
                <button type="button" class="remove-book" onclick="removeBook(this)">Rimuovi</button>
                <button type="button" class="add-book" onclick="createBookEntry()">+ Aggiungi Libro</button>
            `;
            document.getElementById('bookList').appendChild(bookDiv);
            updateBookCounters();
        }

        function removeBook(button) {
            button.parentElement.remove();
            bookCount--;
            updateBookCounters();
        }

        function updateBookCounters() {
            const bookEntries = document.querySelectorAll('.book-entry');
            bookEntries.forEach((entry, index) => {
                entry.querySelector('.book-counter').textContent = index + 1;
            });
        }

        function generateExcel(formData, books) {
            const documentText = `DONAZIONE ALLA BIBLIOTECA ELSA MORANTE

Io sottoscritto ${formData.nome} ${formData.cognome}
Tessera n. ${formData.tessera || '_______________'} 
Tel. ${formData.telefono || '_______________'} 
e-mail ${formData.email}

dono alla Biblioteca le risorse documentarie allegate e autorizzo la biblioteca a destinarli all'uso che riterrà più opportuno (acquisizione al patrimonio, scambio, dono, bookcrossing o scarto, nel caso in cui, a giudizio insindacabile della biblioteca, i materiali risultino inutilizzabili) senza alcun vincolo per la biblioteca stessa nei miei confronti

Data: ${new Date().toLocaleDateString('it-IT')}
`;

            const wb = XLSX.utils.book_new();
            
            const ws_data = [
                ['Donazione alla Biblioteca Elsa Morante'],
                ['', 'Nome', formData.nome],
                ['', 'Cognome', formData.cognome],
                ['', 'Numero Tessera', formData.tessera || '_______________'],
                ['', 'Telefono', formData.telefono || '_______________'],
                ['', 'Email', formData.email],
                [''],
                ['Dichiarazione'],
                [documentText],
                [''],
                ['Elenco dei libri donati:'],
                [''],
                ['Titolo', 'Autore', 'Editore', 'Anno', 'ISBN'],
            ];

            // Aggiungi i libri alla lista
            books.forEach(book => {
                ws_data.push([book.title, book.author, book.publisher, book.year, book.isbn]);
            });

            const ws = XLSX.utils.aoa_to_sheet(ws_data);

            // Formattazione delle celle in grassetto
            const boldCells = [
                { r: 0, c: 0 },  // "Donazione alla Biblioteca Elsa Morante" (A1)
                { r: 1, c: 1 },  // "Nome" (A4)
                { r: 2, c: 1 },  // "Cognome" (A5)
                { r: 3, c: 1 },  // "Numero Tessera" (A6)
                { r: 4, c: 1 },  // "Telefono" (A7)
                { r: 5, c: 1 },  // "Email" (A8)
                { r: 9, c: 0 },  // "Dichiarazione" (A10)
                { r: 15, c: 0 }, // "Titolo" (A16)
                { r: 15, c: 1 }, // "Autore" (B16)
                { r: 15, c: 2 }, // "Editore" (C16)
                { r: 15, c: 3 }, // "Anno" (D16)
                { r: 15, c: 4 }, // "ISBN" (E16)
            ];

            boldCells.forEach(cell => {
                const cellRef = XLSX.utils.encode_cell(cell);
                if (!ws[cellRef]) ws[cellRef] = {};  // Assicurati che la cella esista
                ws[cellRef].s = {
                    font: {
                        bold: true
                    }
                };
            });

            // Imposta la larghezza delle colonne
            ws['!cols'] = [
                { wch: 30 },
                { wch: 20 },
                { wch: 20 },
                { wch: 10 },
                { wch: 15 }
            ];

            XLSX.utils.book_append_sheet(wb, ws, "Donazione");

            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });

            function s2ab(s) {
                const buf = new ArrayBuffer(s.length);
                const view = new Uint8Array(buf);
                for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
                return buf;
            }

            const blob = new Blob([s2ab(wbout)], { type: 'application/octet-stream' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `donazione_${formData.cognome}_${formData.nome}.xlsx`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Creare il primo libro all'avvio
        document.addEventListener('DOMContentLoaded', createBookEntry);

        document.getElementById('donationForm').addEventListener('submit', function(event) {
            event.preventDefault();
            
            const nome = document.getElementById('nome').value.trim();
            const cognome = document.getElementById('cognome').value.trim();
            const tessera = document.getElementById('tessera').value.trim();
            const telefono = document.getElementById('telefono').value.trim();
            const email = document.getElementById('email').value.trim();

            const formData = { nome, cognome, tessera, telefono, email };
            
            const books = [];
            const bookEntries = document.querySelectorAll('.book-entry');
            bookEntries.forEach(entry => {
                const title = entry.querySelector('.book-title').value.trim();
                const author = entry.querySelector('.book-author').value.trim();
                const publisher = entry.querySelector('.book-publisher').value.trim();
                const year = entry.querySelector('.book-year').value.trim();
                const isbn = entry.querySelector('.book-isbn').value.trim();
                
                if (title) {
                    books.push({ title, author, publisher, year, isbn });
                }
            });

            generateExcel(formData, books);
        });
    </script>
</body>
</html>
